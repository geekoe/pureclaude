#!/bin/sh

# Get npm root path
NPM_ROOT=$(npm root -g)

# Build claude-code path
CLAUDE_PATH="$NPM_ROOT/@anthropic-ai/claude-code/"

# Check if path exists
if [ ! -d "$CLAUDE_PATH" ]; then
    echo "Error: claude-code path not found: $CLAUDE_PATH"
    exit 1
fi

# Check if cli.js exists
if [ ! -f "$CLAUDE_PATH/cli.js" ]; then
    echo "Error: cli.js file not found: $CLAUDE_PATH/cli.js"
    exit 1
fi

# Check if cli.js.bak exists
if [ -f "$CLAUDE_PATH/cli.js.bak" ]; then
    # cli.js has already been modified, run it directly
    exec "$CLAUDE_PATH/cli.js" "$@"
fi

# Create backup of original cli.js
cp "$CLAUDE_PATH/cli.js" "$CLAUDE_PATH/cli.js.bak"

# Modify cli.js directly using JavaScript
node -e "
const fs = require('fs');
const content = fs.readFileSync('$CLAUDE_PATH/cli.js', 'utf8');

// Check for required text patterns first
if (!content.includes('You are an interactive CLI tool that helps users with software engineering tasks.')) {
    console.error('Error: Start text not found in cli.js');
    process.exit(1);
}
const lines = content.split('\n');

let inReplaceSection = false;
const result = [];

// Second loop: Process replacements
for (const line of lines) {

    
    let processedLine = line
        .replace(/NEVER create files unless they're absolutely necessary for achieving your goal\./g, '')
        .replace(/ALWAYS prefer editing an existing file to creating a new one\./g, '');
    
    result.push(processedLine);
}

fs.writeFileSync('$CLAUDE_PATH/cli.js', result.join('\n'));
"

# Run the modified cli.js
exec "$CLAUDE_PATH/cli.js" "$@"
